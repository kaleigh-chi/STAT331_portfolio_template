---
title: "Lab 4"
author: "Kaleigh Chi"
format: 
  html:
    self-contained: true
    code-tools: true
    code-fold: true
execute:
  echo: true
  error: true
  messages: false
  warnings: false
editor: visual
---

# Introduction and Set-up

```{r load-in-avocado}
#| message: false

#Question 0
library(tidyverse)
library(here)

avocado <- read_csv(here("Week 4", "Lab 4", "avocado.csv"))
```

```{r examining-avocado}

#Question 1
str(avocado)
```

Question 1: This data set contains information on 18249 weekly observations of avocado sold from different locations from 2015 to 2018. There is a total of 14 variables recorded in the data set. There are num variables for total bags of avocados sold, small bags of avocados sold, large bags of avocados sold, average avocado prices, total number of avocados sold, total number of avocados with PLU 4046, PLU 4225, and PLU 4770. There is a Date variable for the avocado sale date observed, and chr variables for type of avocado observed and the region the avocado sale was observed.

## Question 2

```{r avocado-clean-up}
#Question 2 - Cleaning up avocados dataset to include regions

avocado_clean <- avocado %>%
  filter(region %in% c("Midsouth", "Northeast", "NorthernNewEngland",
                       "Plains", "SouthCentral", "Southeast", "West",
                       "GrandRapids", "GreatLakes"))
```

# Summarizing Avocado Sales

## Question 3

```{r most-organic-small-hass-avocados-2017}
#Question 3 - Most organic small hass avocados in 2017

avocado_clean %>%
  filter(avocado_clean$year == 2017, 
         avocado_clean$type == 'organic') %>%
  group_by(region) %>%
  summarize(Sum = sum((`4046`))) %>%
  mutate(Sum = sort(Sum, decreasing = TRUE))
```

Question 3: The Grand Rapids sold the most organic volume of small avocados in 2017.

## Question 4

```{r month-highest-volume-sales}
#Question 4 - Month with the highest volume of sales

# learned to use the separate() function with source: https://uc-r.github.io/tidyr

avocado_clean %>%
  separate(Date, 
           sep="-", 
           into = c("year", "month", "day")) %>%
  group_by(month) %>%
  summarize(Sum = sum(`Total Volume`))
```

Question 4: January had the highest volume of avocado sales.

## Question 5

```{r cleaning-metro-region}
#Question 5 - Cleaning metro region dataset

#cleaning for metro data using existing avocado and avocado_clean datasets
avocado_metro <- anti_join(avocado, 
                           avocado_clean,
                           by = "region") %>%
  filter(region != "California" & region != "SouthCarolina" & region != "TotalUS")

#examining the top 5 highest average volume sales of avocado in metro regions
avocado_metro %>%
  group_by(region) %>%
  summarize(mean_total_volume = mean(`Total Volume`)) %>%
  slice_max(mean_total_volume, 
            n = 10)

#cleaning avocado_clean dataset for the top 5 metro regions and their average volume sold
avocado_clean <- semi_join(avocado, avocado_metro, by = "region") %>%
  filter(region == 'LosAngeles' | region == 'NewYork' | 
         region == "DallasFtWorth" | region == 'Houston' | 
         region == 'PhoenixTucson') %>%
  group_by(region) %>%
  mutate(mean_total_volume = mean(`Total Volume`)) 
```

```{r plots}
#Question 5 continuing - Plot

#learned how to use scale_y_continuous with source: https://ggplot2.tidyverse.org/reference/scale_continuous.html
#learned how to use scale_fill_manual with source: https://stackoverflow.com/questions/36048033/manually-colouring-plots-with-scale-fill-manual-in-ggplot2-not-working 
#referenced R colors with source: https://www.nceas.ucsb.edu/sites/default/files/2020-04/colorPaletteCheatsheet.pdf

ggplot(avocado_clean, aes(x = `Total Volume`, y  = region, fill = region)) +
  geom_boxplot() +
  scale_fill_manual(values = c("cadetblue", "darkseagreen", "lavender", "khaki", "paleturquoise")) +
  scale_x_continuous(labels = scales::comma) + 
  theme_light() + 
  labs(y = "Metro Region", 
       x = "Total Volume of Avocados Sold", 
       fill = "Metro Region", 
       title = "Avocados Sold by the Top 5 Avocado Selling Metro Regions in the US")
```

The top 5 highest selling metro regions with the highest average Total Volume sold for avocados are Los Angeles, New York, Dallas Fort Worth, Houston, and Phoenix Tucson.

# Reshaping

## Question 6

```{r organic-vs-conventional}
#| message: false

#Question 6 - Cleaning data for organic vs conventional in 4 major california regions

avocado_ca <- avocado_metro %>%
  filter(region == 'LosAngeles' | region == 'SanDiego' | region == 'Sacramento' | region == 'SanFrancisco') %>%
  group_by(type, region) %>%
  summarize(mean = mean(AveragePrice)) %>%
  pivot_wider(names_from = type, values_from = mean) %>%
  mutate(differences = abs(conventional - organic))

avocado_ca
```

```{r}
# Question 6 continuing - Plot

ggplot(avocado_ca, aes(x = region, y = differences)) +
  geom_bar(stat = "identity", fill = "springgreen4") +
  theme_light() +
  labs(x = "CA Regions", 
       y = "Conventional vs Organic Avocado Price Differences", 
       title = "Avocado Price Differences in 4 Major California Regions")
```

The greatest difference between the price of organic vs conventional avocados is found in San Francisco. We find that the average price difference between organic and conventional avocados is \$0.81. This is compared to Los Angeles, Sacramento, and San Diego whose price differences between organic and conventional avocados are \$0.48, \$0.70, and \$0.67 respectively.

## Question 7

```{r}
#Question 7 - Setting up CA dataset with avocado sizes

avocado_metro <- avocado_metro %>%
  group_by(region, type) %>%
  mutate(
    Small = mean(`4046`),
    Large = mean(`4225`),
    `Extra Large` = mean(`4770`)
  )

avocado_ca <- semi_join(avocado_metro, avocado_ca, by = "region") %>%
  select(region, type, `Small`, `Large`, `Extra Large`) %>%
  unique() %>%
  pivot_longer(!region & !type, names_to = "size", values_to = "mean")
```

```{r}
#Question 7 continuing - Plot

#reference to set up stacked bar plot, source: https://r-graph-gallery.com/48-grouped-barplot-with-ggplot2.html
#learned about dodge, source: https://datavizpyr.com/how-to-dodge-overlapping-text-on-x-axis-labels-in-ggplot2/

ggplot(avocado_ca, aes(fill = size, 
                       x = region, 
                       y = mean)) +
  geom_bar(position = position_fill(reverse = TRUE), 
           stat = "identity") +
  scale_fill_manual("Avocado Size", 
                    values = c("lightgreen", "royalblue", "lightblue")) + 
  facet_grid(.~type) +
  labs(x = "Region of CA", 
       y = "Proportion of Mean Avocados Sold") +
  guides(fill = guide_legend(reverse = TRUE)) +
  scale_x_discrete(guide = guide_axis(n.dodge = 2))
  
```
